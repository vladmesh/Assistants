# План рефакторинга проекта

## 1. Стандартизация именования ✅

### 1.1. Текущие проблемы
- Несогласованность в именовании сервисов (например, `rest_service` vs `tg_bot`)
- Разные форматы именования в docker-compose.yml и реальных директориях
- Отсутствие единого стиля для именования контейнеров и образов

### 1.2. План действий
1. ✅ Создать документ с правилами именования:
   - Сервисы: snake_case, с префиксом `smart_assistant_` (например, `smart_assistant_rest`)
   - Контейнеры: kebab-case (например, `smart-assistant-rest`)
   - Образы: snake_case с префиксом `smart_assistant_` (например, `smart_assistant_rest`)
   - Директории: snake_case (например, `smart_assistant_rest`)

2. ✅ Обновить все имена в:
   - docker-compose.yml
   - Директориях сервисов
   - Скриптах управления
   - Документации

## 2. Стандартизация структуры сервисов ✅

### 2.1. Текущие проблемы
- Разные корневые папки в сервисах (где-то `src/`, где-то `app/`)
- Несогласованность в структуре импортов
- Отсутствие единого подхода к организации кода
- Несогласованность в структуре тестовых директорий

### 2.2. План действий
1. ✅ Создать шаблон структуры сервиса
2. ✅ Стандартизировать тестовое окружение
3. ✅ Обновить Dockerfile'ы и docker-compose файлы всех сервисов
4. ✅ Обновить каждый сервис:
   - Переименовать директории
   - Реорганизовать структуру:
     - Переместить код из `app/` в `src/` (для сервисов, использующих `app/`)
     - Обновить все импорты (убрать префикс `src.` из импортов)
     - Обновить пути в Dockerfile'ах
     - Обновить пути в docker-compose файлах
   - Обновить импорты
   - Настроить тестовое окружение

## 3. Внедрение линтеров ✅

### 3.1. Текущие проблемы
- Отсутствие линтеров
- Неоптимальный код
- Несогласованность стиля

### 3.2. План действий
1. ✅ Создать базовую конфигурацию для:
   - ✅ black (форматирование)
   - ✅ isort (сортировка импортов)
   - flake8 (проверка стиля)
   - pylint (анализ кода)
   - mypy (проверка типов)

2. ✅ Настроить pre-commit хуки:
   - ✅ Добавить в существующий pre-commit конфиг
   - ✅ Настроить автоматическое форматирование
   - Добавить проверку типов

3. Создать правила для:
   - Максимальной длины строки (88 символов, как в black)
   - Стиля импортов (группировка: FUTURE, STDLIB, THIRDPARTY, FIRSTPARTY, LOCALFOLDER)
   - Документации
   - Типизации

### 3.3. Следующие шаги
1. Внедрить flake8:
   - Добавить в requirements.txt
   - Создать конфигурацию в pyproject.toml
   - Добавить команду в manage.py
   - Обновить pre-commit хук
   - Настроить правила:
     - Максимальная длина строки: 88 (как в black)
     - Игнорировать правила, конфликтующие с black
     - Проверка документации
     - Проверка сложности кода

## 4. Обновление документации

### 4.1. План действий
1. Обновить файлы контекста:
   - llm_context.md
   - llm_context_assistant.md
   - Другие контекстные файлы

2. Обновить README.md:
   - Добавить информацию о новых правилах
   - Обновить инструкции по разработке
   - Добавить информацию о линтерах

## 5. Порядок выполнения

1. ✅ Создать и утвердить правила именования
2. ✅ Создать шаблон структуры сервиса
3. ✅ Настроить линтеры и pre-commit хуки
4. Обновить каждый сервис в следующем порядке:
   - assistant
   - rest_service
   - google_calendar_service
   - cron_service
   - tg_bot
5. Обновить документацию
6. Провести тестирование всех изменений

## 6. Критерии успеха

- Все сервисы следуют единому стилю именования
- Структура всех сервисов соответствует шаблону
- Линтеры не находят ошибок
- Все тесты проходят успешно
- Документация актуальна и соответствует новым правилам

## 7. Улучшение управления зависимостями

### 7.1. Текущие проблемы
- Разные версии зависимостей в разных сервисах
- Отсутствие централизованного управления версиями
- Отсутствие проверки совместимости версий
- Уязвимости в зависимостях (9 vulnerabilities: 1 critical, 3 high, 5 moderate)

### 7.2. План действий
1. Создать центральный файл с версиями зависимостей:
   ```toml
   # pyproject.toml в корне проекта
   [tool.poetry]
   name = "smart-assistant"
   version = "0.1.0"
   description = "Smart Assistant Project"
   authors = ["Your Name <your.email@example.com>"]

   [tool.poetry.dependencies]
   python = "^3.11"
   fastapi = "^0.104.0"
   uvicorn = "^0.24.0"
   pydantic = "^2.4.2"
   pydantic-settings = "^2.0.3"
   httpx = "^0.25.0"

   [tool.poetry.group.dev.dependencies]
   black = "^23.10.1"
   isort = "^5.12.0"
   flake8 = "^6.1.0"
   mypy = "^1.6.1"

   [tool.poetry.group.test.dependencies]
   pytest = "^7.4.3"
   pytest-asyncio = "^0.21.1"
   pytest-cov = "^4.1.0"

   [tool.poetry.scripts]
   format = "scripts.format:main"
   lint = "scripts.lint:main"
   ```

2. Внедрить Poetry для управления зависимостями:
   - Создать `pyproject.toml` в корне проекта
   - Перенести все зависимости в Poetry
   - Настроить виртуальные окружения через Poetry
   - Создать скрипты для управления:
     ```python
     # scripts/format.py
     def main():
         """Run formatters on all Python files."""
         subprocess.run(["black", "."])
         subprocess.run(["isort", "."])

     # scripts/lint.py
     def main():
         """Run linters on all Python files."""
         subprocess.run(["flake8", "."])
         subprocess.run(["mypy", "."])
     ```
   - Оставить `run_tests.sh` в корне проекта для запуска тестов через Docker

3. Обновить Dockerfile'ы:
   ```dockerfile
   # Базовый образ для разработки
   FROM python:3.11-slim as dev
   RUN pip install poetry
   WORKDIR /app
   COPY pyproject.toml poetry.lock ./
   RUN poetry install --no-root

   # Базовый образ для тестов
   FROM dev as test
   RUN poetry install --no-root --with test

   # Базовый образ для продакшена
   FROM python:3.11-slim as prod
   RUN pip install poetry
   WORKDIR /app
   COPY pyproject.toml poetry.lock ./
   RUN poetry install --no-root --no-dev
   ```

4. Обновить зависимости:
   - Проверить и обновить все зависимости
   - Устранить уязвимости
   - Проверить совместимость версий

### 7.3. Порядок миграции на Poetry
1. Подготовительный этап:
   - Создать `pyproject.toml` в корне проекта
   - Перенести общие зависимости
   - Создать скрипты управления (format.py, lint.py)
   - Оставить run_tests.sh в корне проекта
   - Обновить документацию

2. Миграция сервисов:
   - assistant_service
   - rest_service
   - google_calendar_service
   - cron_service
   - tg_bot

3. Обновление Docker:
   - Создать новые Dockerfile'ы
   - Обновить docker-compose файлы
   - Протестировать сборку и запуск

4. Обновление CI/CD:
   - Добавить Poetry в пайплайны
   - Обновить команды сборки и тестирования
   - Проверить все этапы

## 8. Безопасность зависимостей

### 8.1. Текущие проблемы
- 1 критическая уязвимость
- 3 высоких уязвимости
- 6 средних уязвимостей
- Обнаружены GitHub Dependabot'ом

### 8.2. План действий
1. Аудит зависимостей:
   - Проверить список уязвимостей в GitHub Security
   - Определить критические зависимости
   - Составить план обновления

2. Обновление зависимостей:
   - Обновить критические зависимости в первую очередь
   - Проверить совместимость версий
   - Обновить pyproject.toml и poetry.lock
   - Проверить все сервисы на работоспособность

3. Мониторинг безопасности:
   - Настроить автоматические проверки безопасности
   - Добавить регулярный аудит зависимостей
   - Внедрить автоматическое обновление неопасных зависимостей

### 8.3. Приоритеты
1. Критические уязвимости (высокий приоритет)
2. Высокие уязвимости (средний приоритет)
3. Средние уязвимости (низкий приоритет)

### 8.4. Риски
- Несовместимость версий
- Проблемы с производительностью
- Необходимость обновления кода
- Временные затраты на тестирование

### 8.5. Критерии успеха
- Отсутствие критических уязвимостей
- Все тесты проходят успешно
- Нет проблем с производительностью
- Документация обновлена

## 9. Улучшение управления зависимостями

### 9.1. Текущие проблемы
- Разные версии зависимостей в разных сервисах
- Отсутствие централизованного управления версиями
- Отсутствие проверки совместимости версий
- Уязвимости в зависимостях (9 vulnerabilities: 1 critical, 3 high, 5 moderate)

### 9.2. План действий
1. Создать центральный файл с версиями зависимостей:
   ```toml
   # pyproject.toml в корне проекта
   [tool.poetry]
   name = "smart-assistant"
   version = "0.1.0"
   description = "Smart Assistant Project"
   authors = ["Your Name <your.email@example.com>"]

   [tool.poetry.dependencies]
   python = "^3.11"
   fastapi = "^0.104.0"
   uvicorn = "^0.24.0"
   pydantic = "^2.4.2"
   pydantic-settings = "^2.0.3"
   httpx = "^0.25.0"

   [tool.poetry.group.dev.dependencies]
   black = "^23.10.1"
   isort = "^5.12.0"
   flake8 = "^6.1.0"
   mypy = "^1.6.1"

   [tool.poetry.group.test.dependencies]
   pytest = "^7.4.3"
   pytest-asyncio = "^0.21.1"
   pytest-cov = "^4.1.0"

   [tool.poetry.scripts]
   format = "scripts.format:main"
   lint = "scripts.lint:main"
   ```

2. Внедрить Poetry для управления зависимостями:
   - Создать `pyproject.toml` в корне проекта
   - Перенести все зависимости в Poetry
   - Настроить виртуальные окружения через Poetry
   - Создать скрипты для управления:
     ```python
     # scripts/format.py
     def main():
         """Run formatters on all Python files."""
         subprocess.run(["black", "."])
         subprocess.run(["isort", "."])

     # scripts/lint.py
     def main():
         """Run linters on all Python files."""
         subprocess.run(["flake8", "."])
         subprocess.run(["mypy", "."])
     ```
   - Оставить `run_tests.sh` в корне проекта для запуска тестов через Docker

3. Обновить Dockerfile'ы:
   ```dockerfile
   # Базовый образ для разработки
   FROM python:3.11-slim as dev
   RUN pip install poetry
   WORKDIR /app
   COPY pyproject.toml poetry.lock ./
   RUN poetry install --no-root

   # Базовый образ для тестов
   FROM dev as test
   RUN poetry install --no-root --with test

   # Базовый образ для продакшена
   FROM python:3.11-slim as prod
   RUN pip install poetry
   WORKDIR /app
   COPY pyproject.toml poetry.lock ./
   RUN poetry install --no-root --no-dev
   ```

4. Обновить зависимости:
   - Проверить и обновить все зависимости
   - Устранить уязвимости
   - Проверить совместимость версий

### 9.3. Порядок миграции на Poetry
1. Подготовительный этап:
   - Создать `pyproject.toml` в корне проекта
   - Перенести общие зависимости
   - Создать скрипты управления (format.py, lint.py)
   - Оставить run_tests.sh в корне проекта
   - Обновить документацию

2. Миграция сервисов:
   - assistant_service
   - rest_service
   - google_calendar_service
   - cron_service
   - tg_bot

3. Обновление Docker:
   - Создать новые Dockerfile'ы
   - Обновить docker-compose файлы
   - Протестировать сборку и запуск

4. Обновление CI/CD:
   - Добавить Poetry в пайплайны
   - Обновить команды сборки и тестирования
   - Проверить все этапы

## 10. Улучшение конфигурации

### 10.1. Текущие проблемы
- Разбросанные переменные окружения
- Отсутствие валидации конфигурации
- Сложность управления разными окружениями

### 10.2. План действий
1. Создать систему конфигурации:
   - Внедрить pydantic для валидации конфигурации
   - Создать базовые классы конфигурации
   - Разделить конфигурацию по окружениям (dev, test, prod)

2. Реорганизовать переменные окружения:
   - Создать `.env.example`
   - Разделить `.env` на логические блоки
   - Добавить валидацию при запуске

3. Улучшить управление секретами:
   - Внедрить vault или аналогичное решение
   - Добавить ротацию секретов
   - Улучшить безопасность хранения

## 11. Улучшение тестирования

### 11.1. Текущие проблемы
- Отсутствие единого подхода к тестированию
- Неполное покрытие тестами
- Сложность запуска тестов

### 11.2. План действий
1. Стандартизировать тестирование:
   - Создать базовые фикстуры
   - Добавить factory_boy для создания тестовых данных
   - Настроить pytest-cov для отслеживания покрытия

2. Улучшить CI/CD:
   - Добавить проверку покрытия кода
   - Настроить автоматический запуск тестов
   - Добавить проверку безопасности зависимостей

3. Добавить интеграционные тесты:
   - Создать тестовое окружение
   - Добавить тесты взаимодействия сервисов
   - Настроить автоматическое тестирование API

## 12. Улучшение мониторинга и логирования

### 12.1. Текущие проблемы
- Отсутствие централизованного логирования
- Нет мониторинга производительности
- Сложность отладки

### 12.2. План действий
1. Настроить логирование:
   - Внедрить structlog
   - Добавить контекстное логирование
   - Настроить ротацию логов

2. Добавить мониторинг:
   - Внедрить Prometheus метрики
   - Настроить Grafana дашборды
   - Добавить алерты

3. Улучшить отладку:
   - Добавить трассировку запросов
   - Настроить профилирование
   - Добавить инструменты для анализа производительности

## 13. Обновление порядка выполнения

1. ✅ Создать и утвердить правила именования
2. ✅ Создать шаблон структуры сервиса
3. ✅ Настроить линтеры и pre-commit хуки
4. ✅ Внедрить Poetry и обновить зависимости
5. Улучшить систему конфигурации
6. Обновить каждый сервис в следующем порядке:
   - assistant
   - rest_service
   - google_calendar_service
   - cron_service
   - tg_bot
7. Настроить тестирование и CI/CD
8. Добавить мониторинг и логирование
9. Обновить документацию
10. Провести тестирование всех изменений

## 14. Дополнительные критерии успеха

- Все зависимости управляются через Poetry
- Конфигурация валидируется при запуске
- Тестовое покрытие > 80%
- Настроен мониторинг и логирование
- CI/CD пайплайн успешно проходит
- Все сервисы используют единый подход к логированию
- Документация включает инструкции по развертыванию и мониторингу 