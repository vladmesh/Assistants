# План рефакторинга проекта

## 1. Стандартизация именования ✅

### 1.1. Текущие проблемы
- Несогласованность в именовании сервисов (например, `rest_service` vs `tg_bot`)
- Разные форматы именования в docker-compose.yml и реальных директориях
- Отсутствие единого стиля для именования контейнеров и образов

### 1.2. План действий
1. ✅ Создать документ с правилами именования:
   - Сервисы: snake_case, с префиксом `smart_assistant_` (например, `smart_assistant_rest`)
   - Контейнеры: kebab-case (например, `smart-assistant-rest`)
   - Образы: snake_case с префиксом `smart_assistant_` (например, `smart_assistant_rest`)
   - Директории: snake_case (например, `smart_assistant_rest`)

2. ✅ Обновить все имена в:
   - docker-compose.yml
   - Директориях сервисов
   - Скриптах управления
   - Документации

## 2. Стандартизация структуры сервисов

### 2.1. Текущие проблемы
- Разные корневые папки в сервисах
- Несогласованность в структуре импортов
- Отсутствие единого подхода к организации кода
- Несогласованность в структуре тестовых директорий

### 2.2. План действий
1. Создать шаблон структуры сервиса:
```
smart_assistant_service/
├── src/                    # Исходный код
│   ├── api/               # API endpoints
│   ├── core/              # Основная логика
│   ├── models/            # Модели данных
│   ├── services/          # Внешние сервисы
│   └── utils/             # Утилиты
├── tests/                 # Тесты
│   ├── api/              # Тесты API
│   ├── core/             # Тесты основной логики
│   ├── conftest.py       # Фикстуры pytest
│   └── .env.test         # Тестовые переменные окружения
├── alembic/              # Миграции
├── Dockerfile
├── Dockerfile.test       # Dockerfile для тестов
├── docker-compose.test.yml # Конфигурация тестового окружения
├── requirements.txt
├── pyproject.toml        # Настройки проекта
└── README.md
```

2. Стандартизировать тестовое окружение:
   - Убедиться, что все сервисы имеют директорию `tests/`
   - Создать `Dockerfile.test` для каждого сервиса
   - Создать `docker-compose.test.yml` для каждого сервиса
   - Стандартизировать структуру тестовых директорий
   - Добавить базовые фикстуры в `conftest.py`
   - Настроить переменные окружения для тестов

3. Обновить каждый сервис:
   - Переименовать директории
   - Реорганизовать структуру
   - Обновить импорты
   - Обновить пути в docker-compose.yml
   - Настроить тестовое окружение

## 3. Внедрение линтеров

### 3.1. Текущие проблемы
- Отсутствие линтеров
- Неоптимальный код
- Несогласованность стиля

### 3.2. План действий
1. Создать базовую конфигурацию для:
   - black (форматирование)
   - isort (сортировка импортов)
   - flake8 (проверка стиля)
   - pylint (анализ кода)
   - mypy (проверка типов)

2. Настроить pre-commit хуки:
   - Добавить в существующий pre-commit конфиг
   - Настроить автоматическое форматирование
   - Добавить проверку типов

3. Создать правила для:
   - Максимальной длины строки
   - Стиля импортов
   - Документации
   - Типизации

## 4. Обновление документации

### 4.1. План действий
1. Обновить файлы контекста:
   - llm_context.md
   - llm_context_assistant.md
   - Другие контекстные файлы

2. Обновить README.md:
   - Добавить информацию о новых правилах
   - Обновить инструкции по разработке
   - Добавить информацию о линтерах

## 5. Порядок выполнения

1. Создать и утвердить правила именования
2. Создать шаблон структуры сервиса
3. Настроить линтеры и pre-commit хуки
4. Обновить каждый сервис в следующем порядке:
   - assistant
   - rest_service
   - google_calendar_service
   - cron_service
   - tg_bot
5. Обновить документацию
6. Провести тестирование всех изменений

## 6. Критерии успеха

- Все сервисы следуют единому стилю именования
- Структура всех сервисов соответствует шаблону
- Линтеры не находят ошибок
- Все тесты проходят успешно
- Документация актуальна и соответствует новым правилам

## 7. Улучшение управления зависимостями

### 7.1. Текущие проблемы
- Разные версии зависимостей в разных сервисах
- Отсутствие централизованного управления версиями
- Отсутствие проверки совместимости версий

### 7.2. План действий
1. Создать центральный файл с версиями зависимостей:
   - Создать `requirements.base.txt` с общими зависимостями
   - Создать `requirements.dev.txt` для разработки
   - Создать `requirements.test.txt` для тестов

2. Внедрить Poetry для управления зависимостями:
   - Создать `pyproject.toml` в корне проекта
   - Перенести все зависимости в Poetry
   - Настроить виртуальные окружения через Poetry

3. Обновить Dockerfile'ы:
   - Использовать Poetry для установки зависимостей
   - Оптимизировать слои Docker образов
   - Добавить multi-stage builds

## 8. Улучшение конфигурации

### 8.1. Текущие проблемы
- Разбросанные переменные окружения
- Отсутствие валидации конфигурации
- Сложность управления разными окружениями

### 8.2. План действий
1. Создать систему конфигурации:
   - Внедрить pydantic для валидации конфигурации
   - Создать базовые классы конфигурации
   - Разделить конфигурацию по окружениям (dev, test, prod)

2. Реорганизовать переменные окружения:
   - Создать `.env.example`
   - Разделить `.env` на логические блоки
   - Добавить валидацию при запуске

3. Улучшить управление секретами:
   - Внедрить vault или аналогичное решение
   - Добавить ротацию секретов
   - Улучшить безопасность хранения

## 9. Улучшение тестирования

### 9.1. Текущие проблемы
- Отсутствие единого подхода к тестированию
- Неполное покрытие тестами
- Сложность запуска тестов

### 9.2. План действий
1. Стандартизировать тестирование:
   - Создать базовые фикстуры
   - Добавить factory_boy для создания тестовых данных
   - Настроить pytest-cov для отслеживания покрытия

2. Улучшить CI/CD:
   - Добавить проверку покрытия кода
   - Настроить автоматический запуск тестов
   - Добавить проверку безопасности зависимостей

3. Добавить интеграционные тесты:
   - Создать тестовое окружение
   - Добавить тесты взаимодействия сервисов
   - Настроить автоматическое тестирование API

## 10. Улучшение мониторинга и логирования

### 10.1. Текущие проблемы
- Отсутствие централизованного логирования
- Нет мониторинга производительности
- Сложность отладки

### 10.2. План действий
1. Настроить логирование:
   - Внедрить structlog
   - Добавить контекстное логирование
   - Настроить ротацию логов

2. Добавить мониторинг:
   - Внедрить Prometheus метрики
   - Настроить Grafana дашборды
   - Добавить алерты

3. Улучшить отладку:
   - Добавить трассировку запросов
   - Настроить профилирование
   - Добавить инструменты для анализа производительности

## 11. Обновление порядка выполнения

1. Создать и утвердить правила именования
2. Создать шаблон структуры сервиса
3. Настроить линтеры и pre-commit хуки
4. Внедрить Poetry и обновить зависимости
5. Улучшить систему конфигурации
6. Обновить каждый сервис в следующем порядке:
   - assistant
   - rest_service
   - google_calendar_service
   - cron_service
   - tg_bot
7. Настроить тестирование и CI/CD
8. Добавить мониторинг и логирование
9. Обновить документацию
10. Провести тестирование всех изменений

## 12. Дополнительные критерии успеха

- Все зависимости управляются через Poetry
- Конфигурация валидируется при запуске
- Тестовое покрытие > 80%
- Настроен мониторинг и логирование
- CI/CD пайплайн успешно проходит
- Все сервисы используют единый подход к логированию
- Документация включает инструкции по развертыванию и мониторингу 