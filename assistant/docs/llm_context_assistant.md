# LLM Context Assistant

## 1. Общее описание
Система ассистентов построена на двух основных типах реализации:

### 1.1 BaseLLMChat (LangGraph)
- Реализация через LangGraph
- Использует граф обработки сообщений
- Поддерживает сложные сценарии взаимодействия
- Имеет встроенную поддержку инструментов

### 1.2 OpenAIAssistant (OpenAI Assistants API)
- Реализация через OpenAI Assistants API
- Использует thread-based контекст
- Интегрируется с инструментами через оркестратор
- Поддерживает асинхронную обработку

## 2. Реализация через LangGraph (BaseLLMChat)
### 2.1 Структура
- Инициализация и конфигурация
  ```python
  class BaseLLMChat(BaseAssistant):
      def __init__(self, settings: Settings, is_secretary: bool = False):
          self.settings = settings
          self.is_secretary = is_secretary
          self.agent = None
  ```
- Граф обработки сообщений
  - Узлы для обработки сообщений
  - Узлы для работы с инструментами
  - Узлы для форматирования ответов
- Состояние и контекст
  - Передача user_id через граф
  - Сохранение контекста между узлами
  - Управление историей сообщений

### 2.2 Обработка сообщений
- Формат сообщений LangGraph
  ```python
  {
      "role": "user" | "assistant",
      "content": str
  }
  ```
- Процесс обработки
  1. Получение сообщения
  2. Форматирование для графа
  3. Обработка через узлы
  4. Форматирование ответа
- Передача контекста пользователя
  - Включение user_id в состояние
  - Передача в инструменты
  - Сохранение в истории

### 2.3 Инструменты
- Инициализация инструментов
  ```python
  def _initialize_tools(self):
      tools = [
          TimeToolWrapper(),
          CalendarCreateTool(settings=self.settings),
          CalendarListTool(settings=self.settings),
          SubAssistantTool(settings=self.settings)
      ]
  ```
- Передача user_id
  ```python
  def _set_tool_context(self, user_id: str):
      for tool in self.tools:
          if hasattr(tool, 'user_id'):
              tool.user_id = user_id
  ```
- Специфика работы с календарем
  - Проверка наличия user_id
  - Форматирование ответов
  - Обработка ошибок

### 2.4 Обработка ошибок
- Специфичные ошибки LangGraph
  - Ошибки формата сообщений
  - Ошибки узлов графа
  - Ошибки инструментов
- Логирование
  - Трейсинг через граф
  - Логирование ошибок
  - Мониторинг состояния
- Обработка исключений
  - Graceful degradation
  - Восстановление состояния
  - Информативные сообщения

## 3. Реализация через OpenAI Assistants API (OpenAIAssistant)
### 3.1 Структура
- Инициализация и конфигурация
  ```python
  class OpenAIAssistant(BaseAssistant):
      def __init__(self, settings: Settings):
          self.settings = settings
          self.client = AsyncOpenAI(api_key=settings.openai_api_key)
  ```
- Оркестратор
  - Управление потоками
  - Координация инструментов
  - Обработка состояний
- Управление состоянием
  - Thread-based контекст
  - Сохранение истории
  - Изоляция пользователей

### 3.2 Обработка сообщений
- Формат сообщений OpenAI
  ```python
  {
      "role": "user" | "assistant",
      "content": str,
      "name": str  # для инструментов
  }
  ```
- Процесс обработки
  1. Создание/получение thread
  2. Добавление сообщения
  3. Запуск run
  4. Обработка ответа
- Управление контекстом
  - Сохранение в thread
  - Ограничение длины
  - Очистка истории

### 3.3 Инструменты
- Регистрация инструментов
  ```python
  tools = [
      {
          "type": "function",
          "function": {
              "name": "calendar_create",
              "description": "Create a calendar event",
              "parameters": {...}
          }
      }
  ]
  ```
- Координация через оркестратор
  - Обработка запросов
  - Вызов инструментов
  - Форматирование ответов
- Специфика работы с календарем
  - Передача user_id
  - Обработка результатов
  - Обработка ошибок

### 3.4 Обработка ошибок
- Специфичные ошибки OpenAI
  - API ошибки
  - Ошибки thread
  - Ошибки run
- Логирование
  - Трейсинг запросов
  - Логирование ошибок
  - Мониторинг состояния
- Обработка исключений
  - Retry механизмы
  - Graceful degradation
  - Информативные сообщения

## 4. Общие компоненты
### 4.1 Базовые классы
- `BaseAssistant`
  ```python
  class BaseAssistant:
      def process_message(self, message: str, user_id: str) -> str:
          pass
  ```
- `BaseTool`
  ```python
  class BaseTool:
      def _execute(self, *args, **kwargs) -> Any:
          pass
  ```
- `BaseMessage`
  ```python
  class BaseMessage:
      def __init__(self, content: str, source: str):
          self.content = content
          self.source = source
          self.timestamp = datetime.utcnow()
  ```

### 4.2 Утилиты
- `TimeToolWrapper`
  - Форматирование времени
  - Валидация дат
  - Конвертация часовых поясов
- `RestServiceTool`
  - HTTP запросы
  - Обработка ответов
  - Обработка ошибок
- Общие хелперы
  - Форматирование
  - Валидация
  - Логирование

### 4.3 Конфигурация
- Настройки
  ```python
  class Settings(BaseSettings):
      openai_api_key: str
      redis_url: str
      log_level: str
  ```
- Переменные окружения
  - API ключи
  - URL сервисов
  - Настройки логирования
- Логирование
  - Форматы
  - Уровни
  - Обработчики

## 5. Интеграция с внешними сервисами
### 5.1 Redis
- Хранение контекста
  - Ключи
  - Форматы
  - TTL
- Управление состоянием
  - Сохранение
  - Восстановление
  - Очистка
- Кэширование
  - Стратегии
  - Инвалидация
  - Мониторинг

### 5.2 OpenAI
- Конфигурация API
  - Ключи
  - Модели
  - Таймауты
- Управление токенами
  - Подсчет
  - Лимиты
  - Оптимизация
- Обработка ответов
  - Форматирование
  - Валидация
  - Обработка ошибок

## 6. Разработка и тестирование
### 6.1 Добавление новых инструментов
- Создание инструмента
  ```python
  class NewTool(BaseTool):
      def _execute(self, *args, **kwargs) -> Any:
          # Реализация
          pass
  ```
- Интеграция с ассистентами
  - Регистрация
  - Конфигурация
  - Тестирование
- Тестирование
  - Unit-тесты
  - Интеграционные тесты
  - E2E тесты

### 6.2 Отладка
- Логирование
  - Уровни
  - Форматы
  - Фильтрация
- Трейсинг
  - ID запросов
  - Время выполнения
  - Зависимости
- Мониторинг
  - Метрики
  - Алерты
  - Дашборды

### 6.3 Тестирование
- Unit-тесты
  - Изоляция
  - Моки
  - Сценарии
- Интеграционные тесты
  - Сервисы
  - Базы данных
  - API
- E2E тесты
  - Сценарии
  - Окружение
  - Автоматизация 