# Smart Assistant - Детальное описание реализации

## Архитектура системы

### Сервис ассистента (assistant)

#### Основные компоненты
- **OpenAI Assistant**
  - Реализация на OpenAI Assistants API
  - Поддержка различных моделей (gpt-4-turbo-preview)
  - Управление контекстом и историей диалогов
  - Система инструментов для выполнения задач

- **Инструменты**
  - Calendar Tool - работа с календарем
  - Reminder Tool - управление напоминаниями
  - Time Tool - работа со временем
  - Sub Assistant Tool - управление под-ассистентами
  - Weather Tool - информация о погоде

- **Система сообщений**
  - Асинхронная обработка сообщений через Redis
  - Хранение истории диалогов
  - Поддержка различных типов сообщений
  - Управление контекстом диалога

- **Хранение данных**
  - Redis для кэширования и очередей
  - Хранение истории диалогов
  - Кэширование результатов инструментов
  - Управление сессиями

### REST API сервис (rest_service)

#### Модели данных
- **Assistant**
  - Конфигурация ассистента
  - Типы ассистентов (LLM, OpenAI API)
  - Связи с инструментами
  - Настройки модели
  - Поле `is_secretary` для определения главного ассистента

- **Tool**
  - Название и описание инструмента
  - Тип инструмента (calendar, reminder, time, sub_assistant)
  - JSON схема входных данных
  - Связь с под-ассистентом для sub_assistant типа
  - Статус активности

- **AssistantToolLink**
  - Связь между ассистентом и инструментом
  - Ссылка на под-ассистента для sub_assistant типа
  - Статус активности связи

- **UserAssistantThread**
  - Хранение thread_id для каждого пользователя и ассистента
  - Отслеживание последнего использования
  - Уникальная связь пользователь-ассистент

#### API Endpoints
- Управление ассистентами
  - CRUD операции для ассистентов
  - Получение списка инструментов ассистента
  - Управление связями ассистент-инструмент

- Управление инструментами
  - CRUD операции для инструментов
  - Валидация JSON схем
  - Управление статусами активности

### Google Calendar сервис (google_calendar_service)

#### Функциональность
- Создание и редактирование событий
- Управление календарями
- Интеграция с Google API
- Обработка уведомлений

#### Модели данных
- Event
  - Заголовок и описание
  - Время начала и окончания
  - Участники
  - Локация

### Сервис планировщика (cron_service)

#### Функциональность
- Планирование задач
- Выполнение периодических операций
- Управление напоминаниями
- Обработка событий

#### Модели данных
- ScheduledTask
  - Расписание выполнения
  - Параметры задачи
  - Статус выполнения
  - История выполнения

### Telegram бот (tg_bot)

#### Функциональность
- Обработка сообщений
- Управление диалогами
- Интеграция с ассистентом
- Обработка команд

## Технические детали

### База данных

#### PostgreSQL
- Хранение пользовательских данных
- Конфигурации ассистентов и инструментов
- История взаимодействий
- Настройки сервисов
- Связи между сущностями

#### Redis
- Очереди сообщений
- Кэширование данных
- Хранение сессий
- Управление состоянием

### Асинхронность
- Асинхронная обработка запросов
- Асинхронные операции с базой данных
- Асинхронные очереди сообщений
- Асинхронные вызовы внешних API

### Безопасность
- Аутентификация пользователей
- Авторизация запросов
- Шифрование данных
- Защита API endpoints

### Мониторинг
- Структурированное логирование
- Мониторинг очередей
- Отслеживание ошибок
- Метрики производительности

## Тестирование

### Инфраструктура
- Docker-окружение для тестов
- Изолированные тестовые базы данных
- Моки внешних сервисов
- Автоматизированный запуск тестов

### Типы тестов
- Unit тесты
- Интеграционные тесты
- End-to-end тесты
- Нагрузочные тесты

### CI/CD
- Автоматический запуск тестов
- Проверка качества кода
- Автоматическое развертывание
- Мониторинг деплоя

## Разработка

### Локальное окружение
- Docker Compose для сервисов
- Виртуальное окружение Python
- Локальные базы данных
- Тестовые API ключи

### Инструменты разработки
- Линтеры и форматтеры
- Типизация Python
- Документация API
- Инструменты отладки

### Процесс разработки
- Ветвление и слияние
- Code review
- Автоматические проверки
- Деплой в тестовое окружение

## Последние изменения

### REST Service
- Реализована система управления ассистентами и инструментами
- Добавлена поддержка под-ассистентов
- Реализована валидация JSON схем
- Добавлены тесты для API

### Assistant Service
- Обновлена фабрика ассистентов для работы с REST сервисом
- Реализована поддержка под-ассистентов
- Добавлена валидация данных от REST сервиса
- Улучшена обработка ошибок

### Общие улучшения
- Улучшена структура данных
- Добавлена поддержка UUID для ID
- Реализована система связей между сущностями
- Улучшена документация
