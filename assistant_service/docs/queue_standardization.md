# Стандартизация очередей сообщений

## Общее описание

Необходимо стандартизировать формат сообщений между сервисами через Redis очереди. Все сервисы должны использовать единый формат JSON для обмена сообщениями.

## Текущая ситуация

- Каждый сервис использует свой формат сообщений
- Нет единой структуры для сообщений от инструментов
- Разные сервисы отправляют сообщения напрямую в telegram
- Нет централизованной обработки сообщений

## Решение

### 1. Единый формат сообщений

```json
{
    "type": "tool_message",  // или "human_message"
    "user_id": int,         // ID пользователя в базе данных
    "source": "cron" | "calendar" | "user",  // Источник сообщения
    "content": {
        "message": str,     // Текст сообщения
        "metadata": dict    // Дополнительные данные
    },
    "timestamp": str        // ISO формат времени
}
```

### 2. Архитектура очередей

```
[Крон/Календарь] -> [queue:to_orchestrator] -> [Оркестратор] -> [Секретарь] -> [queue:to_telegram]
[Telegram Bot] -> [queue:to_orchestrator] -> [Оркестратор] -> [Секретарь] -> [queue:to_telegram]
```

## Необходимые изменения

### 1. Cron Service
- Изменить формат сообщений в `redis_client.py`
- Добавить `user_id` вместо `chat_id`
- Добавить метаданные о типе напоминания
- Обновить тесты

### 2. Calendar Service
- Изменить формат сообщений в API роутах
- Добавить `user_id` в сообщения
- Добавить метаданные о типе события
- Обновить тесты

### 3. Telegram Bot Service
- Изменить формат сообщений в `response_handler.py`
- Добавить `user_id` в сообщения
- Обновить обработку входящих сообщений
- Обновить тесты

### 4. Assistant Service (Оркестратор)
- Обновить `message_queue.py` для работы с новым форматом
- Добавить валидацию структуры сообщений
- Обновить логику маршрутизации к секретарю
- Обновить тесты

## Шаги реализации

1. **Подготовка**
   - ✅ Создать Pydantic модели для валидации
   - ✅ Написать тесты для новых моделей
   - [ ] Обновить документацию API

2. **Cron Service**
   - [ ] Обновить `redis_client.py`
   - [ ] Обновить тесты
   - [ ] Проверить работу с новым форматом

3. **Calendar Service**
   - [ ] Обновить API роуты
   - [ ] Обновить тесты
   - [ ] Проверить работу с новым форматом

4. **Telegram Bot Service**
   - [ ] Обновить `response_handler.py`
   - [ ] Обновить тесты
   - [ ] Проверить работу с новым форматом

5. **Assistant Service**
   - ✅ Обновить `message_queue.py`
   - ✅ Обновить логику оркестратора
   - ✅ Обновить тесты
   - [ ] Проверить маршрутизацию

6. **Интеграционное тестирование**
   - [ ] Проверить полный цикл сообщений
   - [ ] Проверить обработку ошибок
   - [ ] Проверить производительность

7. **Документация**
   - [ ] Обновить API документацию
   - [ ] Добавить примеры использования
   - [ ] Описать процесс миграции

## Тестирование

### Unit Tests
- Валидация структуры сообщений
- Обработка ошибок
- Форматирование данных

## Безопасность

- Валидация входных данных
- Проверка прав доступа
- Защита от переполнения
- Логирование действий

