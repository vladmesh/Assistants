# Анализ зависимостей проекта

## Обзор проблем

### 1. Неиспользуемые библиотеки

#### `rest_service`
- ~~**`trio = "^0.24.0"`** - НЕ ИСПОЛЬЗУЕТСЯ. Нигде в коде нет импортов `trio`. Можно удалить.~~ ✅ УДАЛЕНО

#### `assistant_service`
- ~~**`aiopg = "^1.4.0"`** - НЕ ИСПОЛЬЗУЕТСЯ. В коде используется только `asyncpg`. Можно удалить.~~ ✅ УДАЛЕНО
- ~~**`psycopg = {extras = ["binary"], version = "^3.2.6"}`** - НЕ ИСПОЛЬЗУЕТСЯ. В коде используется только `asyncpg`. Можно удалить (в отличие от `rest_service`, здесь нет синхронных миграций Alembic).~~ ✅ УДАЛЕНО
- **`typing-extensions = "^4.9.0"`** - НЕ ИСПОЛЬЗУЕТСЯ напрямую в коде. Скорее всего транзитивная зависимость `pydantic` или `langchain`. Можно удалить после проверки.

#### `google_calendar_service`
- **`google-auth-httplib2 = "^0.2.1"`** - НЕ ИСПОЛЬЗУЕТСЯ напрямую. Используется `google.auth.transport.requests`, который использует `requests`, а не `httplib2`. Может быть требованием `google-api-python-client` - проверить перед удалением.
- **`requests = "^2.32.4"`** - Используется только в `scripts/init_db.py` (вне сервиса). Можно удалить из зависимостей сервиса, если не требуется для тестов или других скриптов.

### 2. Несоответствие версий между сервисами

#### Тестовые зависимости
- ~~**pytest**: 
  - `google_calendar_service`, `rag_service`, `shared_models`: `^7.4.3` (устарело)
  - Остальные: `^8.0.0` или `^8.0.2` или `^8.3.5`
  - **Рекомендация**: Унифицировать до `^8.3.5` (последняя стабильная)~~ ✅ УНИФИЦИРОВАНО до `^8.3.5`

- ~~**pytest-asyncio**:
  - `google_calendar_service`, `rag_service`: `^0.21.1` (устарело)
  - Остальные: `^0.23.5` или `^0.23.8`
  - **Рекомендация**: Унифицировать до `^0.23.8`~~ ✅ УНИФИЦИРОВАНО до `^0.23.8`

- **pytest-cov**: Все используют `^4.1.0` - ОК

- **pytest-mock**: 
  - `google_calendar_service`, `rag_service`: `^3.12.0` - ОК
  - `assistant_service`: `^3.12.0` - ОК
  - Остальные не используют

#### Основные зависимости
- **openai**:
  - `rag_service`: `^1.0.0` (очень старая)
  - `rest_service`: `^1.12.0` (старая)
  - `assistant_service`: `^1.3.0` (старая)
  - **Актуальная версия**: `^1.54.3` (по данным на декабрь 2024)
  - **Рекомендация**: Обновить все до `^1.54.3`

- **fastapi**:
  - Все используют `^0.124.0`
  - **Актуальная версия**: `^0.115.8` (по данным на декабрь 2024)
  - **Примечание**: Версия в проекте новее актуальной - возможно данные устарели или это pre-release

- **uvicorn**:
  - Все используют `^0.27.1`
  - **Актуальная версия**: `^0.34.0` (по данным на декабрь 2024)
  - **Рекомендация**: Обновить до `^0.34.0`

- **sqlmodel**:
  - `rest_service`: `^0.0.23`
  - `cron_service`: `^0.0.16` (старая)
  - **Рекомендация**: Унифицировать до `^0.0.23`

- **alembic**:
  - `rest_service`: `^1.13.1` (старая)
  - `assistant_service`: `^1.15.2`
  - **Рекомендация**: Унифицировать до `^1.15.2`

- **langchain**:
  - `assistant_service`: `^1.1.0`
  - **Актуальная версия**: `^0.3.23` (по данным на декабрь 2024)
  - **Примечание**: Версия в проекте новее - возможно данные устарели или это другая библиотека

- **langgraph**:
  - `assistant_service`: `^1.0.4`
  - **Актуальная версия**: `^0.3.31` (по данным на декабрь 2024)
  - **Примечание**: Версия в проекте новее - возможно данные устарели

### 3. Дублирование зависимостей

#### `assistant_service`
- ~~`shared-models` указан в `[tool.poetry.dependencies]`, `[tool.poetry.group.dev.dependencies]` и `[tool.poetry.group.test.dependencies]`
- **Рекомендация**: Оставить только в основных зависимостях, удалить из dev и test групп~~ ✅ ИСПРАВЛЕНО

### 4. Транзитивные зависимости

Некоторые библиотеки могут быть транзитивными зависимостями других пакетов:
- `urllib3` - может быть транзитивной зависимостью `httpx`, `requests`, `openai`
- `typing-extensions` - может быть транзитивной зависимостью `pydantic`, `langchain`
- `starlette` - транзитивная зависимость `fastapi`

**Рекомендация**: Проверить через `poetry show --tree` и удалить явные зависимости, если они уже включены транзитивно.

### 5. Устаревшие библиотеки

- **`passlib`** в `rest_service`: `^1.7.4` - библиотека в режиме maintenance-only. Рассмотреть замену на `bcrypt` напрямую или `argon2-cffi`.
- **`pytz`** в `assistant_service` и `cron_service`: `^2024.1` - в Python 3.9+ рекомендуется использовать `zoneinfo` из стандартной библиотеки вместо `pytz`.

### 6. Версии Python

Все сервисы используют `python = "^3.12"` - ОК, но стоит проверить совместимость всех библиотек с Python 3.12.

## Рекомендации по приоритетам

### Высокий приоритет
1. ~~Удалить неиспользуемые библиотеки (`trio`, `aiopg`, `psycopg` из `assistant_service`, `google-auth-httplib2` из `google_calendar_service`)~~ ✅ ЧАСТИЧНО ВЫПОЛНЕНО (trio, aiopg, psycopg удалены; google-auth-httplib2 требует дополнительной проверки)
2. ~~Унифицировать версии pytest и pytest-asyncio во всех сервисах~~ ✅ ВЫПОЛНЕНО
3. Обновить `openai` во всех сервисах до актуальной версии
4. Обновить `uvicorn` до актуальной версии

### Средний приоритет
1. Унифицировать версии `sqlmodel` и `alembic`
2. ~~Удалить дублирование `shared-models` из dev/test групп в `assistant_service`~~ ✅ ВЫПОЛНЕНО
3. Проверить транзитивные зависимости и удалить явные, если они уже включены

### Низкий приоритет
1. ~~Рассмотреть замену `pytz` на `zoneinfo`~~ ✅ ВЫПОЛНЕНО
2. Рассмотреть замену `passlib` на прямую работу с `bcrypt` или `argon2-cffi`
3. Проверить актуальность версий `langchain` и `langgraph` (данные могут быть устаревшими)

## Дополнительные замечания

- `requests` используется только в `scripts/init_db.py` (вне сервисов) - можно вынести в отдельный скрипт или добавить в зависимости только для dev окружения
- `google-auth-httplib2` может быть требованием `google-api-python-client` - проверить через `poetry show --tree` перед удалением
- `psycopg2-binary` в `rest_service` используется для синхронных миграций Alembic - **НЕ УДАЛЯТЬ**
- `psycopg` в `assistant_service` не используется (нет синхронных миграций) - можно удалить
- `typing-extensions` может быть транзитивной зависимостью - проверить через `poetry show --tree` перед удалением
